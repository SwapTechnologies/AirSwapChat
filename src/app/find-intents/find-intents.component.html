<div>
  <h1>
    Search the Indexer for Peers
  </h1>
  <div>
    <span *ngIf="selectedRole === 'maker'">
      <mat-form-field>
        <mat-select 
        placeholder="Search Token" 
        [(value)]="selectedToken"
        (selectionChange)="showIntents()">
          <mat-option 
          *ngFor="let token of tokenList | callback: filterEther" 
          [value]='token'>
            {{token.name}} ({{token.address.slice(0,8)}}...)
          </mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field>
        <mat-select 
        placeholder="What is your role" 
        [(value)]="selectedRole"
        (selectionChange)="showIntents()">
          <mat-option value="maker">I want to buy it</mat-option>
          <mat-option value="taker">I want to sell it</mat-option>
        </mat-select> 
      </mat-form-field>
      <button 
        mat-icon-button 
        color="primary"
        (click)="showIntents()">
        <mat-icon>autorenew</mat-icon>
      </button>  
    </span>

    <span *ngIf="selectedRole === 'taker'">
      <mat-form-field>
        <mat-select 
        placeholder="Search Token" 
        [(value)]="selectedToken"
        (selectionChange)="showIntents()">
          <mat-option 
          *ngFor="let token of tokenList" 
          [value]='token'>
            {{token.name}} ({{token.address.slice(0,8)}}...)
          </mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field>
        <mat-select 
        placeholder="What is your role" 
        [(value)]="selectedRole"
        (selectionChange)="showIntents()">
          <mat-option value="maker">I want to buy it</mat-option>
          <mat-option value="taker">I want to sell it</mat-option>
        </mat-select> 
      </mat-form-field>
    </span>
  </div>

  <div *ngIf="stillLoading" class="row">
    <mat-progress-spinner
    class="progress_spinner"
    color="primary"
    mode="indeterminate">
    </mat-progress-spinner>
    <p>Standby. Fetching peers, their balances and checking who's online</p>
  </div>
  <div *ngIf="!stillLoading">
    <div *ngIf="foundIntents.length>0">
      <div *ngIf="selectedRole === 'maker'">
        <p>
          <i>Peers selling <b>{{selectedToken.name}}</b></i>
        </p>
        <div *ngFor="let intent of foundIntents" class="row">
          <div *ngIf="intent.makerToken" class="peerCard">
            <mat-card>
              <mat-card-title>
                {{intent.alias}} wants {{intent.takerProps.symbol}}
                <span *ngIf="intent.isOnline" class="onlineDot"></span>
                <span *ngIf="!(intent.isOnline)" class="offlineDot"></span>  
              </mat-card-title>
              <mat-card-subtitle>
                  Address {{intent.address}}
              </mat-card-subtitle>
              <mat-card-subtitle>
                  Peer <b>sells {{intent.makerProps.name}}</b> to <b>buy {{intent.takerProps.name}}</b>
              </mat-card-subtitle>
              <mat-card-content>
                <i>In peers wallet are:</i> 
                {{intent.makerBalanceMakerToken / intent.makerDecimals}}
                {{intent.makerProps.symbol}},
                {{intent.makerBalanceTakerToken / intent.takerDecimals}}
                {{intent.takerProps.symbol}}
                <br/>
                <i>In your wallet are:</i> 
                {{intent.takerBalanceTakerToken / intent.takerDecimals}}
                {{intent.takerProps.symbol}},
                {{intent.takerBalanceMakerToken / intent.makerDecimals}}
                {{intent.makerProps.symbol}}
              </mat-card-content>
              <mat-card-content>
                <button mat-raised-button
                (click)="message(intent)">MESSAGE</button>
                <button mat-raised-button *ngIf="intent.approvedTakerToken > 0"
                (click)="openDialogGetOrder(intent)"
                [disabled]="!intent.isOnline">
                  GET ORDER
                </button>           
                <button mat-raised-button *ngIf="!(intent.approvedTakerToken > 0)"
                [disabled]="clickedApprove[intent.takerToken]"
                (click)="approveTaker(intent)">
                  APPROVE {{intent.takerProps.symbol}}
                </button>              
              </mat-card-content>
              <mat-card-content *ngIf="intent.sentRequest">
                <i>Sent request for an offer of 
                {{this.getOrderService.sentOrders[intent.sentRequest].makerAmount / this.getOrderService.sentOrders[intent.sentRequest].makerDecimals}}
                {{this.getOrderService.sentOrders[intent.sentRequest].makerProps.symbol}}</i>
              </mat-card-content>
            </mat-card>
          </div>
        </div>
      </div>
      <div *ngIf="selectedRole==='taker'">
        <p>
          <i>Peers buying <b>{{selectedToken.name}}</b></i>
        </p>
        <div *ngFor="let intent of foundIntents" class="row">
          <div *ngIf="callGetTokenByAddress(intent.takerToken)" class="peerCard">
            <mat-card>
              <mat-card-title>
                {{intent.alias}} sells {{intent.makerProps.symbol}}
                <span *ngIf="intent.isOnline" class="onlineDot"></span>
                <span *ngIf="!(intent.isOnline)" class="offlineDot"></span>  
              </mat-card-title>
              <mat-card-subtitle>
                  Address {{intent.address}}
              </mat-card-subtitle>
              <mat-card-subtitle>
                  Peer <b>buys {{intent.takerProps.name}}</b> to <b>sell {{intent.makerProps.name}}</b>
              </mat-card-subtitle>
              <mat-card-content>
                <i>In peers wallet are:</i> 
                {{intent.makerBalanceMakerToken / intent.makerDecimals}}
                {{intent.makerProps.symbol}},
                {{intent.makerBalanceTakerToken / intent.takerDecimals}}
                {{intent.takerProps.symbol}}
                <br/>
                <i>In your wallet are:</i> 
                {{intent.takerBalanceTakerToken / intent.takerDecimals}}
                {{intent.takerProps.symbol}},
                {{intent.takerBalanceMakerToken / intent.makerDecimals}}
                {{intent.makerProps.symbol}}
              </mat-card-content>
              <mat-card-content>
                <button mat-raised-button
                (click)="message(intent)">MESSAGE</button>
                <button mat-raised-button *ngIf="(intent.approvedTakerToken > 0)"
                (click)="openDialogGetOrder(intent)"
                [disabled]="!intent.isOnline">
                  GET ORDER
                </button>           
                <button mat-raised-button *ngIf="!(intent.approvedTakerToken > 0)"
                [disabled]="clickedApprove[intent.takerToken]"
                (click)="approveTaker(intent)">
                  APPROVE {{intent.takerProps.symbol}}
                </button>        
              </mat-card-content>
            </mat-card>
          </div>
        </div>
      </div>        
    </div>
    <div *ngIf="selectedToken && foundIntents.length === 0">
      <p *ngIf="selectedRole==='maker'">
        Sorry, nobody has signaled a intent to sell {{selectedToken.name}} in the indexer at the moment.
      </p>
      <p *ngIf="selectedRole==='taker'">
        Sorry, nobody has signaled a intent to buy {{selectedToken.name}} in the indexer at the moment.
      </p>
    </div>
  </div>
</div>